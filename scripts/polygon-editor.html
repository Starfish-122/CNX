<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>구역 폴리곤 좌표 에디터</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family: 'Noto Sans KR', -apple-system, sans-serif;
                display: flex;
                height: 100vh;
            }
            .sidebar {
                width: 350px;
                background: #f8f9fa;
                padding: 20px;
                overflow-y: auto;
                border-right: 2px solid #dee2e6;
            }
            .map-container {
                flex: 1;
                position: relative;
            }
            #map {
                width: 100%;
                height: 100%;
            }
            h1 {
                font-size: 20px;
                margin-bottom: 15px;
                color: #212529;
            }
            .location-selector {
                margin-bottom: 20px;
            }
            select {
                width: 100%;
                padding: 10px;
                font-size: 14px;
                border: 1px solid #ced4da;
                border-radius: 4px;
                background: white;
            }
            .instructions {
                background: #e7f3ff;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
                font-size: 13px;
                line-height: 1.6;
            }
            .instructions strong {
                color: #0066cc;
            }
            .points-list {
                background: white;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 20px;
                max-height: 200px;
                overflow-y: auto;
            }
            .point-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px;
                margin-bottom: 5px;
                background: #f8f9fa;
                border-radius: 4px;
                font-size: 12px;
                font-family: 'Courier New', monospace;
            }
            .point-item button {
                padding: 4px 8px;
                font-size: 11px;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
            }
            .point-item button:hover {
                background: #c82333;
            }
            .actions {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
            }
            button {
                flex: 1;
                padding: 10px;
                font-size: 14px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
            }
            .btn-clear {
                background: #6c757d;
                color: white;
            }
            .btn-clear:hover {
                background: #5a6268;
            }
            .btn-save {
                background: #28a745;
                color: white;
            }
            .btn-save:hover {
                background: #218838;
            }
            .output {
                background: #282c34;
                color: #abb2bf;
                padding: 15px;
                border-radius: 8px;
                font-size: 12px;
                font-family: 'Courier New', monospace;
                white-space: pre-wrap;
                word-break: break-all;
                max-height: 300px;
                overflow-y: auto;
            }
            .output-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
            }
            .output-header h3 {
                font-size: 14px;
                color: #212529;
            }
            .btn-copy {
                padding: 6px 12px;
                font-size: 12px;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            .btn-copy:hover {
                background: #0056b3;
            }
            .status {
                text-align: center;
                padding: 10px;
                margin-bottom: 10px;
                border-radius: 4px;
                font-size: 13px;
                font-weight: 500;
            }
            .status.success {
                background: #d4edda;
                color: #155724;
            }
            .map-info {
                position: absolute;
                top: 10px;
                left: 10px;
                background: white;
                padding: 10px 15px;
                border-radius: 8px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
                font-size: 13px;
                z-index: 100;
            }
        </style>
    </head>
    <body>
        <div class="sidebar">
            <h1>🗺️ 폴리곤 좌표 에디터</h1>

            <div class="location-selector">
                <select id="locationSelect">
                    <option value="한강로길">한강로길</option>
                    <option value="용리단길">용리단길</option>
                    <option value="아모레 / LS">아모레 / LS</option>
                    <option value="래미안">래미안</option>
                    <option value="아이파크몰">아이파크몰</option>
                    <option value="용산철길">용산철길</option>
                </select>
            </div>

            <div class="instructions">
                <strong>📍 사용 방법:</strong><br />
                1. 위에서 구역을 선택하세요<br />
                2. 지도를 클릭하여 폴리곤 경계점을 추가<br />
                3. 최소 3개 이상의 점을 찍으세요<br />
                4. "저장" 버튼을 눌러 코드 생성<br />
                5. 생성된 코드를 복사하여 constants.ts에 붙여넣기
            </div>

            <div id="status"></div>

            <h3 style="font-size: 14px; margin-bottom: 10px">
                선택한 점 (<span id="pointCount">0</span>개)
            </h3>
            <div class="points-list" id="pointsList"></div>

            <div class="actions">
                <button class="btn-clear" onclick="clearPoints()">모두 지우기</button>
                <button class="btn-save" onclick="savePolygon()">저장</button>
            </div>

            <div class="output-header">
                <h3>📋 생성된 코드</h3>
                <button class="btn-copy" onclick="copyToClipboard()">복사</button>
            </div>
            <div class="output" id="output">// 지도를 클릭하여 폴리곤 경계를 설정하세요</div>
        </div>

        <div class="map-container">
            <div class="map-info">
                <strong>🎯 현재 구역:</strong> <span id="currentLocation">한강로길</span><br />
                <strong>📍 클릭한 점:</strong> <span id="clickCount">0</span>개
            </div>
            <div id="map"></div>
        </div>

        <script
            type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5beb8d010f9c2f7fe60f99489c4effa3"
        ></script>
        <script>
            // 환경 변수에서 API 키 가져오기 (개발 시)
            const API_KEY = '5beb8d010f9c2f7fe60f99489c4effa3'; // .env 파일의 NEXT_PUBLIC_KAKAO_MAP_KEY로 교체하세요

            let map;
            let polygon = null;
            let points = [];
            let markers = [];
            const polygonData = {};

            // 초기 위치 (용산 중심)
            const DEFAULT_CENTER = { lat: 37.532, lng: 126.965 };

            // 지도 초기화
            function initMap() {
                const container = document.getElementById('map');
                const options = {
                    center: new kakao.maps.LatLng(DEFAULT_CENTER.lat, DEFAULT_CENTER.lng),
                    level: 4,
                };

                map = new kakao.maps.Map(container, options);

                // 지도 클릭 이벤트
                kakao.maps.event.addListener(map, 'click', function (mouseEvent) {
                    const latlng = mouseEvent.latLng;
                    addPoint(latlng.getLat(), latlng.getLng());
                });

                console.log('✅ 지도 초기화 완료');
            }

            // 점 추가
            function addPoint(lat, lng) {
                const point = {
                    lat: parseFloat(lat.toFixed(4)),
                    lng: parseFloat(lng.toFixed(4)),
                };
                points.push(point);

                // 마커 추가
                const marker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(lat, lng),
                    map: map,
                });
                markers.push(marker);

                updatePointsList();
                updatePolygon();
                updateClickCount();
            }

            // 점 목록 업데이트
            function updatePointsList() {
                const listDiv = document.getElementById('pointsList');
                listDiv.innerHTML = points
                    .map(
                        (p, i) => `
                <div class="point-item">
                    <span>${i + 1}. lat: ${p.lat}, lng: ${p.lng}</span>
                    <button onclick="removePoint(${i})">삭제</button>
                </div>
            `
                    )
                    .join('');

                document.getElementById('pointCount').textContent = points.length;
            }

            // 점 제거
            function removePoint(index) {
                points.splice(index, 1);

                // 마커 제거
                if (markers[index]) {
                    markers[index].setMap(null);
                }
                markers.splice(index, 1);

                updatePointsList();
                updatePolygon();
                updateClickCount();
            }

            // 모든 점 지우기
            function clearPoints() {
                points = [];
                markers.forEach((m) => m.setMap(null));
                markers = [];

                if (polygon) {
                    polygon.setMap(null);
                    polygon = null;
                }

                updatePointsList();
                updateClickCount();
                document.getElementById('output').textContent =
                    '// 지도를 클릭하여 폴리곤 경계를 설정하세요';
            }

            // 폴리곤 업데이트
            function updatePolygon() {
                // 기존 폴리곤 제거
                if (polygon) {
                    polygon.setMap(null);
                }

                // 3개 이상의 점이 있을 때만 폴리곤 생성
                if (points.length >= 3) {
                    const path = points.map((p) => new kakao.maps.LatLng(p.lat, p.lng));

                    polygon = new kakao.maps.Polygon({
                        map: map,
                        path: path,
                        strokeWeight: 3,
                        strokeColor: '#0066cc',
                        strokeOpacity: 1,
                        fillColor: '#0080ff',
                        fillOpacity: 0.3,
                    });
                }
            }

            // 클릭 카운트 업데이트
            function updateClickCount() {
                document.getElementById('clickCount').textContent = points.length;
            }

            // 폴리곤 저장
            function savePolygon() {
                const location = document.getElementById('locationSelect').value;

                if (points.length < 3) {
                    showStatus('❌ 최소 3개 이상의 점을 추가하세요', false);
                    return;
                }

                polygonData[location] = [...points];

                // TypeScript 코드 생성
                const code = generateCode(location);
                document.getElementById('output').textContent = code;

                showStatus(`✅ ${location} 폴리곤이 저장되었습니다`, true);
            }

            // 코드 생성
            function generateCode(location) {
                const pointsCode = points
                    .map((p) => `        { lat: ${p.lat}, lng: ${p.lng} },`)
                    .join('\n');

                return `    // ${location}
    ${location}: [
${pointsCode}
    ],`;
            }

            // 전체 코드 생성
            function generateAllCode() {
                const locations = Object.keys(polygonData);
                if (locations.length === 0) return '// 저장된 폴리곤이 없습니다';

                const codes = locations.map((loc) => generateCode(loc)).join('\n');

                return `export const LOCATION_POLYGONS: Record<LocationKey, Coordinates[]> = {
${codes}
} as const;`;
            }

            // 클립보드에 복사
            function copyToClipboard() {
                const output = document.getElementById('output').textContent;
                navigator.clipboard
                    .writeText(output)
                    .then(() => {
                        showStatus('📋 클립보드에 복사되었습니다', true);
                    })
                    .catch(() => {
                        showStatus('❌ 복사 실패', false);
                    });
            }

            // 상태 메시지 표시
            function showStatus(message, success) {
                const statusDiv = document.getElementById('status');
                statusDiv.textContent = message;
                statusDiv.className = `status ${success ? 'success' : 'error'}`;

                setTimeout(() => {
                    statusDiv.textContent = '';
                    statusDiv.className = 'status';
                }, 3000);
            }

            // 구역 변경 이벤트
            document.getElementById('locationSelect').addEventListener('change', function () {
                const location = this.value;
                document.getElementById('currentLocation').textContent = location;

                // 기존 폴리곤이 저장되어 있으면 불러오기
                if (polygonData[location]) {
                    clearPoints();
                    points = [...polygonData[location]];

                    // 마커 재생성
                    points.forEach((p) => {
                        const marker = new kakao.maps.Marker({
                            position: new kakao.maps.LatLng(p.lat, p.lng),
                            map: map,
                        });
                        markers.push(marker);
                    });

                    updatePointsList();
                    updatePolygon();
                    updateClickCount();

                    const code = generateCode(location);
                    document.getElementById('output').textContent = code;
                } else {
                    clearPoints();
                }
            });

            // 페이지 로드 시 지도 초기화
            window.onload = function () {
                // API 키 확인
                if (API_KEY === 'YOUR_APP_KEY') {
                    alert(
                        '⚠️ scripts/polygon-editor.html 파일의 API_KEY를 실제 카카오맵 API 키로 교체하세요!\n\n.env.local 파일의 NEXT_PUBLIC_KAKAO_MAP_KEY 값을 사용하세요.'
                    );
                }

                initMap();
            };
        </script>
    </body>
</html>
